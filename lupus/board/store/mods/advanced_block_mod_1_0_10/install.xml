<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<?xml-stylesheet type="text/xsl" href="./modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
<header>
	<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>
	<title lang="en">Advanced Block Mod</title>
	<description lang="en">Adds more DNS blacklists to phpBB3.
		Blacklists can be managed from ACP.
		Blacklists can be weighted from 0 to 5 to reach a threshold value of 5 to bring several blacklists in combination for blocking.
		Adds a new log for Block actions.
		Adds logging to validate_email and check_dnsbl.
		Adds WHOIS to logs.</description>

	<author-notes lang="en"></author-notes>

	<author-group>
		<author>
			<realname>Martin Truckenbrodt</realname>
			<username>Martin Truckenbrodt</username>
			<homepage>http://www.martin-truckenbrodt.com</homepage>
		</author>
	</author-group>

	<mod-version>1.0.10</mod-version>

	<installation>
		<level>easy</level>
		<time>900</time>
		<target-version>3.0.9</target-version>
	</installation>

	<history>
		<entry>
			<date>2009-04-20</date>
			<rev-version>0.0.1</rev-version>
			<changelog lang="en">
				<change>first release</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-04-20</date>
			<rev-version>0.0.2</rev-version>
			<changelog lang="en">
				<change>some bugfixes - http://www.phpbb.com/community/viewtopic.php?p=9325865#p9325865</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-04-27</date>
			<rev-version>1.0.0</rev-version>
			<changelog lang="en">
				<change>MOD renamed from More DNS Blaklists MOD into Advanced Block MOD</change>
				<change>first release candidate for validation at the phpbb.com MODDB</change>
				<change>block UTC -12 (first entry of the dropdown menue) feature added</change>
				<change>enable block logs from ACP added</change>
				<change>german language support added</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-04-28</date>
			<rev-version>1.0.1</rev-version>
			<changelog lang="en">
				<change>some bugs fixed found while MOD validation</change>
				<change>one missing edit added for includes/ucp_register.php</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-05-13</date>
			<rev-version>1.0.2</rev-version>
			<changelog lang="en">
				<change>some bugs fixed found while MOD validation</change>
				<change>UMIL 1.0.0-RC3 support</change>
				<change>Fill DNSBL_TABLE now with umil_auto_dnsbl_list.php - using new feature in UMIL 1.0.0-RC3</change>
			</changelog>
		</entry>
		<entry>
			<date>2009-05-13</date>
			<rev-version>1.0.3</rev-version>
			<changelog lang="en">
				<change>DNSBLs list updated</change>
				<change>UMIL 1.0.1-pl1 support - using new feature for table row updates</change>
				<change>MODX 1.2.3 support</change>
			</changelog>
		</entry>
		<entry>
			<date>2010-01-05</date>
			<rev-version>1.0.3a</rev-version>
			<changelog lang="en">
				<change>unneeded CRs deleted</change>
			</changelog>
		</entry>
		<entry>
			<date>2010-06-18</date>
			<rev-version>1.0.4</rev-version>
			<changelog lang="en">
				<change>unneeded CRs deleted</change>
				<change>umil_auto_dnsbl_list.php removed - now only umil_auto_dnsbl.php is needed</change>
				<change>sort order for the DNSBLs changed for check_dnsbl - first dnsbl_weight and second left_id</change>
			</changelog>
		</entry>
		<entry>
			<date>2010-07-18</date>
			<rev-version>1.0.5</rev-version>
			<changelog lang="en">
				<change>UMIL 1.0.2</change>
				<change>unneeded file copy removed</change>
				<change>MOD policy changes done</change>
			</changelog>
		</entry>
		<entry>
			<date>2010-07-30</date>
			<rev-version>1.0.6</rev-version>
			<changelog lang="en">
				<change>UMIL 1.0.2</change>
				<change>string check and DNS A record check for new FQDN entries added and changed</change>
				<change>two problems fixed found while MOD validation</change>
			</changelog>
		</entry>
		<entry>
			<date>2011-03-30</date>
			<rev-version>1.0.7</rev-version>
			<changelog lang="en">
				<change>sort order now first dnsbl_weight and second dnsbl_count - used for ACP page and dnsbl_check</change>
				<change>dnsbl_register setting removed - If enabled then all DNS blacklists now are used for guest postings, too.</change>
				<change>Blacklist opm.tornevall.org renamed to dnsbl.tornevall.org  - http://forum.tornevall.net/showthread.php?353128-dnsbl.tornevall.org-or-opm.tornevall.org</change>
				<change>dnsbl_weight of two DNS Blacklists changed to 0 - http://www.phpbb.com/customise/db/mod/advanced_block_mod/faq/f_534</change>
				<change>sort order for the DNSBLs replaced with the counter</change>
				<change>UMIL 1.0.4</change>
			</changelog>
		</entry>
		<entry>
			<date>2011-07-15</date>
			<rev-version>1.0.8</rev-version>
			<changelog lang="en">
				<change>two small phpBB 3.0.9 compatibility issues with styles/prosilver/template/ucp_register.html and includes/functions_admin.php fixed</change>
				<change>DNSBL combined.njabl.org added</change>
				<change>DNSBL dnsbl.tornevall.org weight value increased to 5 - not any false positives found for a long time</change>
				<change>DNSBL access.atlbl.net weight value decreased to 0 (deactivated) - seems to be corrupt or shut down :(</change>
			</changelog>
		</entry>
		<entry>
			<date>2011-08-02</date>
			<rev-version>1.0.9</rev-version>
			<changelog lang="en">
				<change>some bugs found while MOD validation fixed</change>
				<change>dnsbl check on posting only for guests now</change>
			</changelog>
		</entry>
		<entry>
			<date>2011-09-14</date>
			<rev-version>1.0.10</rev-version>
			<changelog lang="en">
				<change>missing MOD version update in UMIL file fixed</change>
				<change>ANSI file type in /root/langugae/de/mods/dnsbl.php fixed - at least I hope taht I have fixed it now</change>
			</changelog>
		</entry>
	</history>
	<link-group>
		<link type="language" href="contrib/languages/de.xml" lang="en">german</link>
		<link type="template" href="contrib/templates/subsilver2.xml" lang="en">subsilver2</link>
	</link-group>
</header>

<action-group>
	<copy>
		<file from="root/adm/style/acp_dnsbl.html" to="adm/style/acp_dnsbl.html" />
		<file from="root/includes/acp/acp_dnsbl.php" to="includes/acp/acp_dnsbl.php" />
		<file from="root/includes/acp/info/acp_dnsbl.php" to="includes/acp/info/acp_dnsbl.php" />
		<file from="root/language/en/mods/dnsbl.php" to="language/en/mods/dnsbl.php" />
		<file from="root/language/en/mods/umil_auto_dnsbl.php" to="language/en/mods/umil_auto_dnsbl.php" />
		<file from="root/umil/*.*" to="umil/*.*" />
		<file from="root/umil_auto_dnsbl.php" to="umil_auto_dnsbl.php" />
	</copy>
	<open src="adm/style/acp_logs.html">
		<edit>
			<find><![CDATA[			<td style="text-align: center;">{log.IP}</td>]]></find>
			<inline-edit>
				<inline-find><![CDATA[{log.IP}]]></inline-find>
				<inline-action type="replace-with"><![CDATA[<a href="{log.U_SHOW_IP}">{log.IP}</a><br />[ <a href="{log.U_WHOIS}" onclick="popup(this.href, 700, 500, '_whois'); return false;">{L_WHOIS}</a> ]]]></inline-action>
			</inline-edit>
		</edit>
	</open>
	<open src="includes/acp/acp_board.php">
		<edit>
			<find><![CDATA[						'check_dnsbl'			=> array('lang' => 'CHECK_DNSBL',			'validate' => 'bool',	'type' => 'radio:yes_no', 'explain' => true),]]></find>
			<action type="after-add"><![CDATA[						'log_check_dnsbl'		=> array('lang' => 'LOG_CHECK_DNSBL',		'validate' => 'bool',	'type' => 'radio:yes_no', 'explain' => false),]]></action>
		</edit>
		<edit>
			<find><![CDATA[						'email_check_mx'		=> array('lang' => 'EMAIL_CHECK_MX',		'validate' => 'bool',	'type' => 'radio:yes_no', 'explain' => true),]]></find>
			<action type="after-add"><![CDATA[						'log_email_check_mx'	=> array('lang' => 'LOG_EMAIL_CHECK_MX',	'validate' => 'bool',	'type' => 'radio:yes_no', 'explain' => false),
						'check_tz'				=> array('lang' => 'CHECK_TZ',				'validate' => 'bool',	'type' => 'radio:yes_no', 'explain' => true),
						'log_check_tz'			=> array('lang' => 'LOG_CHECK_TZ',			'validate' => 'bool',	'type' => 'radio:yes_no', 'explain' => false),]]></action>
		</edit>
	</open>
	<open src="includes/acp/acp_logs.php">
		<edit>
			<find><![CDATA[		$marked		= request_var('mark', array(0));]]></find>
			<action type="after-add"><![CDATA[		$ip			= request_var('ip', 'ip');]]></action>
		</edit>
		<edit>
			<find><![CDATA[		$this->log_type = constant('LOG_' . strtoupper($mode));
]]></find>
			<action type="after-add"><![CDATA[		// Whois (special case)
		if ($action == 'whois')
		{
			include($phpbb_root_path . 'includes/functions_user.' . $phpEx);

			$user->add_lang('acp/users');

			$this->page_title = 'WHOIS';
			$this->tpl_name = 'simple_body';

			$user_ip = request_var('user_ip', '');
			$domain = gethostbyaddr($user_ip);
			$ipwhois = user_ipwhois($user_ip);

			$template->assign_vars(array(
				'MESSAGE_TITLE'		=> sprintf($user->lang['IP_WHOIS_FOR'], $domain),
				'MESSAGE_TEXT'		=> nl2br($ipwhois))
			);

			return;
		}
]]></action>
		</edit>
		<edit>
			<find><![CDATA[			$checks = array('viewtopic', 'viewlogs', 'viewforum');]]></find>
			<inline-edit>
				<inline-find><![CDATA[)]]></inline-find>
				<inline-action type="before-add"><![CDATA[, 'dnsbllookup']]></inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[				'IP'				=> $row['ip'],]]></find>
			<inline-edit>
				<inline-find><![CDATA[$row['ip']]]></inline-find>
				<inline-action type="before-add"><![CDATA[($ip == 'hostname') ? gethostbyaddr_with_cache($row['ip']) : ]]></inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[				'ID'				=> $row['id'],]]></find>
			<action type="after-add"><![CDATA[				'U_SHOW_IP'			=> $this->u_action . "&amp;start=$start&amp;ip=" . (($ip == 'ip') ? 'hostname' : 'ip'),
				'U_WHOIS'			=> $this->u_action . "&amp;action=whois&amp;user_ip={$row['ip']}",]]></action>
		</edit>
		<edit>
			<find><![CDATA[?>]]></find>
			<action type="before-add"><![CDATA[/**
* performance increasing with using cache for DNS queries
* took idea from http://www.php.net/manual/en/function.gethostbyaddr.php#25091
**/
function gethostbyaddr_with_cache($address)
{
	global $dns_cache;

	if (isset($dns_cache[$address]))
	{
		return $dns_cache[$address];
	}
	else
	{
		$dns_cache[$address] = gethostbyaddr($address);
		return $dns_cache[$address];
	}
}
]]></action>
		</edit>
	</open>
	<open src="includes/acp/info/acp_logs.php">
		<edit>
			<find><![CDATA[				'critical'	=> array('title' => 'ACP_CRITICAL_LOGS', 'auth' => 'acl_a_viewlogs', 'cat' => array('ACP_FORUM_LOGS')),]]></find>
			<action type="after-add"><![CDATA[				'block'		=> array('title' => 'ACP_BLOCK_LOGS', 'auth' => 'acl_a_viewlogs', 'cat' => array('ACP_FORUM_LOGS')),]]></action>
		</edit>
	</open>
	<open src="includes/constants.php">
		<edit>
			<find><![CDATA[// Additional constants]]></find>
			<action type="after-add"><![CDATA[define('LOG_BLOCK', 4);
define('WEIGHT_ZERO', 0);
define('WEIGHT_ONE', 1);
define('WEIGHT_TWO', 2);
define('WEIGHT_THREE', 3);
define('WEIGHT_FOUR', 4);
define('WEIGHT_FIVE', 5);]]></action>
		</edit>
		<edit>
			<find><![CDATA[// Additional tables]]></find>
			<action type="after-add"><![CDATA[define('DNSBL_TABLE',				$table_prefix . 'dnsbl');]]></action>
		</edit>
	</open>
	<open src="includes/functions.php">
		<edit>
			<find><![CDATA[function tz_select($default = '', $truncate = false)]]></find>
			<inline-edit>
				<inline-find><![CDATA[$truncate = false]]></inline-find>
				<inline-action type="after-add"><![CDATA[, $mode = false]]></inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[	global $user;

	$tz_select = '';]]></find>
			<inline-edit>
				<inline-find><![CDATA[	global $user]]></inline-find>
				<inline-action type="after-add"><![CDATA[, $config]]></inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[	foreach ($user->lang['tz_zones'] as $offset => $zone)]]></find>
			<action type="replace-with"><![CDATA[	$timezones = $user->lang['tz_zones'];

	if ($mode !== 'register' || !$config['check_tz'])
	{
		$non_timezones = array('-19' => $user->lang['tz_zones']['-19'], '19' => $user->lang['tz_zones']['19']);
		$timezones = array_diff_assoc($timezones, $non_timezones);
	}

	foreach ($timezones as $offset => $zone)]]></action>
		</edit>
		<edit>
			<find><![CDATA[	$topic_id		= ($mode == 'mod') ? intval(array_shift($args)) : '';]]></find>
			<action type="after-add"><![CDATA[	$dnsbl_id		= ($mode == 'block') ? intval(array_shift($args)) : '';]]></action>
		</edit>
		<edit>
			<find><![CDATA[		case 'critical':
			$sql_ary['log_type'] = LOG_CRITICAL;
		break;
]]></find>
			<action type="after-add"><![CDATA[		case 'block':
			$sql_ary += array(
				'log_type'	=> LOG_BLOCK,
				'dnsbl_id'	=> $dnsbl_id
			);
		break;
]]></action>
		</edit>
	</open>
	<open src="includes/functions_admin.php">
		<edit>
			<find><![CDATA[	$topic_id_list = $reportee_id_list = $is_auth = $is_mod = array();]]></find>
			<inline-edit>
				<inline-find><![CDATA[$reportee_id_list = ]]></inline-find>
				<inline-action type="after-add"><![CDATA[$dnsbl_id_list = ]]></inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[		case 'critical':
			$log_type = LOG_CRITICAL;
			$sql_forum = '';
		break;
]]></find>
			<action type="after-add"><![CDATA[		case 'block':
			$log_type = LOG_BLOCK;
			$sql_forum = '';
		break;
]]></action>
		</edit>
		<edit>
			<find><![CDATA[		if ($row['reportee_id'])
		{
			$reportee_id_list[] = $row['reportee_id'];
		}
]]></find>
			<action type="after-add"><![CDATA[		if ($row['dnsbl_id'])
		{
			$dnsbl_id_list[] = $row['dnsbl_id'];
		}
]]></action>
		</edit>
		<edit>
			<find><![CDATA[			'reportee_username_full'=> '',]]></find>
			<action type="after-add"><![CDATA[			'dnsbl_id'				=> $row['dnsbl_id'],]]></action>
		</edit>
		<edit>
			<find><![CDATA[	if ($log_count !== false)]]></find>
			<action type="before-add"><![CDATA[	if (sizeof($dnsbl_id_list))
	{
		$dnsbl_id_list = array_unique($dnsbl_id_list);
		$dnsbl_lookup_list = array();

		$sql = 'SELECT dnsbl_id, dnsbl_fqdn, dnsbl_lookup
			FROM ' . DNSBL_TABLE . '
			WHERE ' . $db->sql_in_set('dnsbl_id', $dnsbl_id_list);
		$result = $db->sql_query($sql);

		while ($row = $db->sql_fetchrow($result))
		{
			$dnsbl_lookup_list[$row['dnsbl_id']] = $row;
		}
		$db->sql_freeresult($result);

		foreach ($log as $key => $row)
		{

			if (!isset($dnsbl_lookup_list[$row['dnsbl_id']]))
			{
				continue;
			}

			if (!$dnsbl_lookup_list[$row['dnsbl_id']]['dnsbl_lookup'])
			{
				$log[$key]['dnsbllookup'] = '';
			}
			else
			{
				$log[$key]['dnsbllookup'] = $dnsbl_lookup_list[$row['dnsbl_id']]['dnsbl_lookup'] . $log[$key]['ip'];
			}
		}
	}
]]></action>
		</edit>
	</open>
	<open src="includes/functions_user.php">
		<edit>
			<find><![CDATA[			return 'DOMAIN_NO_MX_RECORD';]]></find>
			<action type="before-add"><![CDATA[			if ($config['log_email_check_mx'])
			{
				add_log('block', 0, 'LOG_DNSMX', $domain);
			}]]></action>
		</edit>
	</open>
	<open src="includes/session.php">
		<edit>
			<find><![CDATA[	function check_dnsbl($mode, $ip = false)
	{]]></find>
			<action type="after-add"><![CDATA[		global $db, $config;]]></action>
		</edit>
		<edit>
			<find><![CDATA[		$dnsbl_check = array(
			'sbl.spamhaus.org'	=> 'http://www.spamhaus.org/query/bl?ip=',
		);

		if ($mode == 'register')
		{
			$dnsbl_check['bl.spamcop.net'] = 'http://spamcop.net/bl.shtml?';
		}

		if ($ip)
		{
			$quads = explode('.', $ip);
			$reverse_ip = $quads[3] . '.' . $quads[2] . '.' . $quads[1] . '.' . $quads[0];

			// Need to be listed on all servers...
			$listed = true;
			$info = array();

			foreach ($dnsbl_check as $dnsbl => $lookup)
			{
				if (phpbb_checkdnsrr($reverse_ip . '.' . $dnsbl . '.', 'A') === true)
				{
					$info = array($dnsbl, $lookup . $ip);
				}
				else
				{
					$listed = false;
				}
			}

			if ($listed)
			{]]></find>
			<action type="replace-with"><![CDATA[		if ($ip)
		{
			$quads = explode('.', $ip);
			$reverse_ip = $quads[3] . '.' . $quads[2] . '.' . $quads[1] . '.' . $quads[0];

			// Need to be listed on all servers...
			$weight = 0;
			$info = array();

			$sql = 'SELECT dnsbl_id, dnsbl_fqdn, dnsbl_lookup, dnsbl_weight FROM ' . DNSBL_TABLE . "
				WHERE dnsbl_weight > '0'
				ORDER BY dnsbl_weight DESC, dnsbl_count DESC";

			$result = $db->sql_query($sql);

			while ($row = $db->sql_fetchrow($result))
			{
				if (phpbb_checkdnsrr($reverse_ip . '.' . $row['dnsbl_fqdn'] . '.', 'A') === true)
				{
					$info = array($row['dnsbl_fqdn'], $row['dnsbl_lookup'] . $ip);
					if ($config['log_check_dnsbl'])
					{
						add_log('block', $row['dnsbl_id'], 'LOG_DNSBL_FOUND', $row['dnsbl_fqdn']);
					}
					$weight += $row['dnsbl_weight'];

					$sql = 'UPDATE ' . DNSBL_TABLE . '
						SET dnsbl_count = dnsbl_count + 1 
						WHERE dnsbl_id = ' . $row['dnsbl_id'];
					$db->sql_query($sql);
				}
				if ($weight > 4)
				{
					break;
				}
			}

			$db->sql_freeresult($result);

			if ($weight > 4)
			{
				if ($config['log_check_dnsbl'])
				{
					add_log('block', 0, ($mode == 'register') ? 'LOG_DNSBL_REGISTER' : 'LOG_DNSBL');
				}]]></action>
		</edit>
	</open>
	<open src="includes/ucp/ucp_register.php">
		<edit>
			<find><![CDATA[		$error = $cp_data = $cp_error = array();]]></find>
			<action type="after-add"><![CDATA[		$dnsbl_positive = '';]]></action>
		</edit>
		<edit>
			<find><![CDATA[				'tz'				=> array('num', false, -14, 14),]]></find>
			<action type="replace-with"><![CDATA[				'tz'				=> array('num', false, -19, 19),]]></action>
		</edit>
		<edit>
			<find><![CDATA[			// DNSBL check]]></find>
			<action type="before-add"><![CDATA[			// non terrestrial timezone check
			// anti spam check for the former UTC -12 trick
			if ($config['check_tz'])
			{
				if ((float) $data['tz'] == -19 || (float) $data['tz'] == 19)
				{
					if ($config['log_check_tz'])
					{
						add_log('block', 0, 'LOG_WRONG_TZ', (float) $data['tz']);
					}
					$error[] = $user->lang['WRONG_TIMEZONE'];
				}
			}
]]></action>
		</edit>
		<edit>
			<find><![CDATA[					$error[] = sprintf($user->lang['IP_BLACKLISTED'], $user->ip, $dnsbl[1]);]]></find>
			<action type="after-add"><![CDATA[					$dnsbl_positive = true;]]></action>
		</edit>
		<edit>
			<find><![CDATA[			'ERROR'				=> (sizeof($error)) ? implode('<br />', $error) : '',]]></find>
			<action type="after-add"><![CDATA[			'DNSBL_POSITIVE'	=> $dnsbl_positive,]]></action>
		</edit>
		<edit>
			<find><![CDATA[			'S_TZ_OPTIONS'		=> tz_select($data['tz']),]]></find>
			<inline-edit>
				<inline-find><![CDATA[),]]></inline-find>
				<inline-action type="before-add"><![CDATA[, false, 'register']]></inline-action>
			</inline-edit>
		</edit>
	</open>
	<open src="language/en/acp/board.php">
		<edit>
			<find><![CDATA[	'CHECK_DNSBL_EXPLAIN'			=> 'If enabled the user’s IP address is checked against the following DNSBL services on registration and posting: <a href="http://spamcop.net">spamcop.net</a> and <a href="http://www.spamhaus.org">www.spamhaus.org</a>. This lookup may take a while, depending on the server’s configuration. If slowdowns are experienced or too many false positives reported it is recommended to disable this check.',]]></find>
			<inline-edit>
				<inline-find><![CDATA[the following DNSBL services on registration and posting: <a href="http://spamcop.net">spamcop.net</a> and <a href="http://www.spamhaus.org">www.spamhaus.org</a>]]></inline-find>
				<inline-action type="replace-with"><![CDATA[DNSBL services on registration and posting]]></inline-action>
			</inline-edit>
		</edit>
		<edit>
			<find><![CDATA[	'CLASS_B'						=> 'A.B',]]></find>
				<action type="before-add"><![CDATA[	'CHECK_TZ'						=> 'Check timezone setting',
	'CHECK_TZ_EXPLAIN'				=> 'If enabled the user’s timezone is checked against non-terrestrial values of -19 and +19 on registration. Spammer often are using the first or the last entry of the drop down menu. If this option is enabled two strange values are added to the begin and the end of the dropdown menue only on registration.',]]></action>
		</edit>
		<edit>
			<find><![CDATA[	'IP_VALID_EXPLAIN'				=> 'Determines how much of the users IP is used to validate a session; <samp>All</samp> compares the complete address, <samp>A.B.C</samp> the first x.x.x, <samp>A.B</samp> the first x.x, <samp>None</samp> disables checking. On IPv6 addresses <samp>A.B.C</samp> compares the first 4 blocks and <samp>A.B</samp> the first 3 blocks.',]]></find>
				<action type="after-add"><![CDATA[	'LOG_CHECK_DNSBL'				=> 'Enable block log for DNSBL check',
	'LOG_CHECK_TZ'					=> 'Enable block log for timezone setting check',
	'LOG_EMAIL_CHECK_MX'			=> 'Enable block log for e-mail domain valid MX record check',]]></action>
		</edit>
	</open>
	<open src="language/en/acp/common.php">
		<edit>
			<find><![CDATA[?>]]></find>
			<action type="before-add"><![CDATA[// Advanced Block Mod
$lang = array_merge($lang, array(
	'ACP_BLOCK_LOGS'			=> 'Block log',
	'ACP_BLOCK_LOGS_EXPLAIN'	=> 'This lists the actions carried out by timezone check and by DNS check e.g. while user registration. This log provides you with information you are able to use for controlling the DNSBL check function. If you have appropriate permissions you can also clear individual operations or the log as a whole.<br /><strong>The different logs have to be enabled under SECURITY SETTINGS!</strong>',
	'ACP_DNSBL'					=> 'DNSBL settings',

	'LOG_CLEAR_BLOCK'			=> '<strong>Cleared block log</strong>',
	'LOG_DNSBL'					=> '<strong>User blocked by DNSBL check.</strong><br />For more information look at other entries for the same IP address.',
	'LOG_DNSBL_ADD'				=> '<strong>Created new DNS Blacklist entry</strong><br />» %s',
	'LOG_DNSBL_DELETE'			=> '<strong>Deleted DNS Blacklist entry</strong><br />» %s',
	'LOG_DNSBL_EDIT'			=> '<strong>Edited DNS Blacklist entry details</strong><br />» %s',
	'LOG_DNSBL_FOUND'			=> '<strong>IP address of spammer recognized by DNSBL check</strong><br />»Blacklist “<em>%s</em>”',
	'LOG_DNSBL_MOVE_DOWN'		=> '<strong>Moved DNS Blacklist</strong> %1$s <strong>below</strong> %2$s',
	'LOG_DNSBL_MOVE_UP'			=> '<strong>Moved DNS Blacklist</strong> %1$s <strong>above</strong> %2$s',
	'LOG_DNSBL_REGISTER'		=> '<strong>User blocked while registration by DNSBL check.</strong><br />For more information look at other entries for the same IP address.',
	'LOG_DNSMX'					=> '<strong>User e-mail address blocked by DNS MX check.</strong><br />»Domain “<em>%s</em>”',
	'LOG_WRONG_TZ'				=> '<strong>User blocked by timezone check.</strong><br />»Timezone “<em>%s</em>”',
));
]]></action>
		</edit>
	</open>
	<open src="language/en/common.php">
		<edit>
			<find><![CDATA[	'IP_BLACKLISTED'			=> 'Your IP %1$s has been blocked because it is blacklisted. For details please see <a href="%2$s">%2$s</a>.',]]></find>
			<action type="after-add"><![CDATA[	'IP_BLACKLISTED_INFO'		=> 'An entry on the blaklist may have several reasons:<br />1. You are a well-known spammer.<br />2. Last time a well-known spammer was using the dynamic IP address which you got from your ISP (Internet Service Provider).<br />3. Your ISP is well-known for a lot of spamming customers and is not fighting against spammers.',]]></action>
		</edit>
		<edit>
			<find><![CDATA[	'WRONG_PASSWORD'	=> 'You entered an incorrect password.',]]></find>
			<action type="after-add"><![CDATA[	'WRONG_TIMEZONE'	=> 'You entered an incorrect timezone. Only <a href="http://en.wikipedia.org/wiki/Spambot">Spambots</a> are using this timezone!',]]></action>
		</edit>
		<edit>
			<find><![CDATA[		'-12'	=> '[UTC - 12] Baker Island Time',]]></find>
			<action type="before-add"><![CDATA[		'-19'	=> '[UTC - 199] Spambot Time',]]></action>
		</edit>
		<edit>
			<find><![CDATA[		'14'	=> '[UTC + 14] Line Island Time',]]></find>
			<action type="after-add"><![CDATA[		'19'	=> '[UTC + 199] Spambot Time',]]></action>
		</edit>
	</open>
	<open src="language/en/mcp.php">
		<edit>
			<find><![CDATA[	'LOGVIEW_VIEWFORUM'			=> 'View forum',]]></find>
			<action type="after-add"><![CDATA[	'LOGVIEW_DNSBLLOOKUP'		=> 'Lookup blacklist',]]></action>
		</edit>
	</open>
	<open src="posting.php">
		<edit>
			<find><![CDATA[	if ($config['check_dnsbl'] && !$refresh)]]></find>
			<inline-edit>
				<inline-find><![CDATA[	if ($config['check_dnsbl']]]></inline-find>
				<inline-action type="after-add"><![CDATA[ && !$user->data['is_registered']]]></inline-action>
			</inline-edit>
		</edit>
	</open>
	<open src="styles/prosilver/template/ucp_register.html">
		<edit>
			<find><![CDATA[	<!-- IF ERROR --><dl><dd class="error">{ERROR}</dd></dl><!-- ENDIF -->]]></find>
			<action type="after-add"><![CDATA[<!-- IF DNSBL_POSITIVE -->
	<dl><dd class="error">{L_IP_BLACKLISTED_INFO}</dd></dl>
<!-- ELSE -->]]></action>
		</edit>
		<edit>
			<find><![CDATA[	<span class="corners-bottom"><span></span></span></div>
</div>
</form>]]></find>
			<action type="before-add"><![CDATA[<!-- ENDIF -->
]]></action>
		</edit>
	</open>
	<php-installer>umil_auto_dnsbl.php</php-installer>
</action-group>
</mod>